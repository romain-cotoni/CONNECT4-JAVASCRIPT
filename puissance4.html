<!-- la fonction createPlayboard est en jquery-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puissance 4</title>
    <style>
        :root {
            --hoverColor: blue;          
        }
        html, body {
            height: 100%;
        }
        body {
            display        : flex;
            flex-direction : column;
            justify-content: center;
            align-items    : center;
        }
        h1 {
            margin-top: 0;
            margin-bottom: 0;
        }
        div.container {
            display  : flex;
            flex-wrap: wrap;
            border   : 1px solid black;
            height   : 600px;
            width    : 700px;
        }
        div.container div {
            border    : 1px solid black;
            box-sizing: border-box;
        }
        div.col:hover {
            background-color: var(--hoverColor);
        }
        button {
            width:48%;
        }
        </style>
</head>
<body>
    <h1>Puissance 4 à 2 joueurs</h1>
    <p id="msg">joueur bleu à vous de jouer</p>
    <div id="container" class="container"></div>

    <div class="replay" id="replay">
        <div class="message">souhaitez vous rejouer ?</div>
        <button id="oui">Oui</button>
        <button id="non">Non</button>
    </div>

<!--<script type="text/javascript" src="puissance4-jquery.js">-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
        crossorigin="anonymous">
</script>
<script>
    var game = true;
    var color1 = 'blue';
    var color2 = 'red';
    var elementColor = color1;
    var name = 'bleu';
    var nbRow = 6;
    var nbCol = 7;
    var countBlueRow = 0;
    var countBlueCol = [];
    var countRedRow = 0;
    var countRedCol = [];
    var countRow = countBlueRow;
    var countCol = countBlueCol;
    var joueur = false;

    createPlayboard(nbRow, nbCol);

    function createPlayboard(nbRow, nbCol) 
    {
        $("#replay").hide();//cacher la dialog box de fin de partie
        var container = $('#container');
        for (var row = 0; row < nbRow; row++) 
        {
            for (var col = 0; col < nbCol; col++) 
            {
                var element = container.append(
                    $('<div>')
                    .attr("id", row + "-" + col)
                    .addClass("col")
                    .css("height", (100 / nbRow) + "%")
                    .css("width" , (100 / nbCol) + "%")
                );
                if(row === 0) container.on('click','#'+row+'-'+col ,selectCase);              
            }
        }
    }

    function selectCase(eventMouseClick) {        
        $(eventMouseClick).css("background", elementColor);
        var row = eventMouseClick.target.id.split("-")[0];
        var col = eventMouseClick.target.id.split("-")[1];
        fallDown(row, col);
    }

    function fallDown(row, col) {
        setTimeout(function () //setTimeout pour ralentir la chute des carré
        {               
            var nextRow = document.getElementById((row + "-" + col).toString());//selectionne le row suivant
            //si le row suivant est libre:
            if ((row < nbRow) && nextRow.style.backgroundColor != color1 && nextRow.style.backgroundColor != color2) {                
                changeColorPreviousRow(row, col);
                nextRow.style.background = elementColor;
                row++;
                fallDown(row, col);
            }
            else {
                checkWinInRows();
                checkWinInCols();
                if(game) switchPlayer();
            }
        }, 50);
    }

    function changeColorPreviousRow(row, col) 
    {
        if(row > 0) var prevRow  = document.getElementById(((row - 1) + "-" + col).toString());
        else        var prevRow  = document.getElementById(((row    ) + "-" + col).toString());
        prevRow.style.background = 'white';
        prevRow.style.background = null; //pour que la div change toujours de couleur quand hoveré
    }

    function switchPlayer() {
        joueur = !joueur;
        if (joueur == false) {
            name = 'bleu';
            elementColor = 'blue';
            victoryColor = 'lightblue';
            countRow = countBlueRow;
            countCol = countBlueCol;
        }
        else {
            name = 'rouge';
            elementColor = 'red';
            victoryColor = 'tomato';
            countRow = countRedRow;
            countCol = countRedCol;
        }
        var root = document.documentElement;
        $(root).css("--hoverColor",elementColor);
        displayMessage("joueur " + name + " à vous de jouer");
    }

    function displayMessage(message) {
        document.getElementById("msg").innerHTML = message;
    }

    function checkWinInRows() {
        for (var row = 0; row < nbRow; row++) {
            for (var col = 0; col < nbCol; col++) {
                var id = (row + "-" + col).toString();
                if (document.getElementById(id).style.backgroundColor == color1) {
                    countBlueCol++;
                    if ((countBlueCol) >= 4) win('horizontal', row, col);

                }
                else countBlueCol = 0;
                if (document.getElementById(id).style.backgroundColor == color2) {
                    countRedCol++;
                    if ((countRedCol) >= 4) win('horizontal', row, col);
                }
                else countRedCol = 0;
            }
        }
    }
    function checkWinInCols() {
        for (var col = 0; col < nbCol; col++) {
            for (var row = 0; row < nbRow; row++) {
                var id = (row + "-" + col).toString();
                if (document.getElementById(id).style.backgroundColor == color1) {
                    countBlueRow++;
                    if ((countBlueRow) >= 4) win('vertical', row, col);

                }
                else countBlueRow = 0;
                if (document.getElementById(id).style.backgroundColor == color2) {
                    countRedRow++;
                    if ((countRedRow) >= 4) win('vertical', row, col);
                }
                else countRedRow = 0;
            }
        }
    }

    function win(direction, row, col) {
        if (direction === "horizontal") {
            for (var i = col; i > (col - 4); i--) {
                document.getElementById((row + "-" + i).toString()).style.backgroundColor = victoryColor;
            }
        }
        else if (direction === "vertical") {
            for (var i = row; i > (row - 4); i--) {
                document.getElementById((i + "-" + col).toString()).style.backgroundColor = victoryColor;
            }
        }
        displayMessage("joueur " + name + " vous avez gagné");
        game = false;
        functionAlert();
    }
    
    function functionAlert(msg, myYes) 
    {
        var confirmBox = $("#replay");
        confirmBox.find(".message").text(msg);
        confirmBox.find("#oui").on('click', replay);
        confirmBox.find("#non").on('click', gameover);
        confirmBox.show();
    }
    function gameover() 
    {
        window.location.href = 'https://romain-cotoni.github.io/portfolio/';
    }
    function replay() 
    {
        var container = $('#container');
        for (var col = 0; col < nbCol; col++) {
            container.off('click', '#0-' + col, selectCase);//disconnect event listener
        }
        location.reload(true);
    }
</script>

</body>
</html>